name: Daily Notifications Production (Every 6 Hours)

on:
  schedule:
    # Run every 6 hours: 12:00 AM, 6:00 AM, 12:00 PM, 6:00 PM UTC
    - cron: '0 */6 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  notification-batch:
    runs-on: ubuntu-latest
    name: Daily notification system (runs every 6 hours)

    steps:
      - name: üîî Daily Notification System
        run: |
          echo "üïò Starting daily notifications at $(date)"
          echo "üì± Running subscription expiry, inactive user, and new content notifications"

          # Check for new video content in the last 24 hours and send notifications
          echo "üìπ Checking for new video content published in last 24 hours using enhanced notification system..."
          new_content_response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/notification-triggers" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "x-client-info: github-cron-daily" \
            -d '{
              "check_hours": 24,
              "system": "enhanced"
            }')

          # Test subscription expiry notifications
          echo "‚è∞ Checking subscription expiry notifications..."
          expiry_response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/trigger_subscription_expiry_check" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          # Test inactive user notifications
          echo "üë• Checking inactive user notifications..."
          inactive_response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/trigger_inactive_user_notification" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          # Extract and display content check results
          content_http_code=$(echo "$new_content_response" | tail -n1)
          content_response_body=$(echo "$new_content_response" | head -n -1)

          echo "üìä Enhanced Content Check Response Code: $content_http_code"
          echo "üìÑ Enhanced Content Check Response: $content_response_body"

          if [ "$content_http_code" = "200" ]; then
            echo "‚úÖ Enhanced notification system content check completed successfully!"
            echo "üÜï New notifications will be available in both new (notifications table) and legacy (user_notifications table) systems"
          else
            echo "‚ùå Enhanced notification system content check failed with code: $content_http_code"
            echo "Error details: $content_response_body"
          fi

          echo "üèÅ Enhanced notification system completed at $(date)"

      - name: üìä Notification Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Enhanced notification system completed successfully"
            echo "üì± Check Supabase database for new notifications in both systems:"
            echo "   ‚Ä¢ notifications table (new enhanced system)"
            echo "   ‚Ä¢ user_notifications table (legacy compatibility)"
            echo "üîÑ Next run will be in 6 hours"
          else
            echo "‚ùå Enhanced notification system failed - check logs above"
            echo "‚ö†Ô∏è Admin should review the error and fix any issues"
          fi

      - name: üßπ Production Status
        if: success()
        run: |
          echo "üöÄ Enhanced production notification system running every 6 hours"
          echo "üìß Check Supabase Edge Function logs for detailed insights:"
          echo "   ‚Ä¢ notification-triggers function (enhanced system)"
          echo "üìã Monitor database tables for new entries:"
          echo "   ‚Ä¢ notifications table (new system)"
          echo "   ‚Ä¢ notification_reads table (new system)"
          echo "   ‚Ä¢ user_notifications table (legacy compatibility)"