name: YouTube Auto-Sync Every 3 Hours

on:
  schedule:
    # Run every 3 hours at minute 0
    # Times: 12:00 AM, 3:00 AM, 6:00 AM, 9:00 AM, 12:00 PM, 3:00 PM, 6:00 PM, 9:00 PM UTC
    - cron: '0 */3 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  youtube-sync:
    runs-on: ubuntu-latest
    name: Check for new YouTube videos

    steps:
      - name: ğŸ“¹ YouTube Auto-Sync Check
        run: |
          echo "ğŸ•’ Starting YouTube auto-sync at $(date)"
          echo "ğŸ¯ Target: Ruwaq Jawi YouTube playlists"

          # Call the Supabase Edge Function
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/youtube-check-new-videos-fixed" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")

          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n1)

          # Extract response body (all lines except last)
          response_body=$(echo "$response" | head -n -1)

          echo "ğŸ“Š Response Code: $http_code"
          echo "ğŸ“„ Response Body: $response_body"

          # Check if request was successful
          if [ "$http_code" = "200" ]; then
            echo "âœ… YouTube sync completed successfully!"

            # Parse and display results using jq if available
            if command -v jq > /dev/null; then
              echo "$response_body" | jq -r '
                if .total_new_videos > 0 then
                  "ğŸ‰ Found " + (.total_new_videos | tostring) + " new videos across " + (.synced_playlists | tostring) + " playlists!"
                else
                  "âœ¨ All " + (.synced_playlists | tostring) + " playlists are up to date."
                end'

              # Show detailed results if any new videos found
              echo "$response_body" | jq -r '
                if .results and (.results | length > 0) then
                  "ğŸ“‹ Playlist Details:" + "\n" +
                  (.results[] |
                    if .new_videos > 0 then
                      "  ğŸ†• " + .kitab_title + ": " + (.new_videos | tostring) + " new videos"
                    else
                      "  âœ… " + .kitab_title + ": up to date"
                    end
                  )
                else
                  ""
                end'
            else
              echo "Response: $response_body"
            fi
          else
            echo "âŒ YouTube sync failed with code: $http_code"
            echo "Error details: $response_body"
            exit 1
          fi

          echo "ğŸ YouTube auto-sync completed at $(date)"

      - name: ğŸ“Š Sync Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Sync job completed successfully"
            echo "ğŸ“± Students will receive notifications for any new videos"
            echo "ğŸ”„ Next sync will run in 3 hours"
          else
            echo "âŒ Sync job failed - check logs above"
            echo "âš ï¸ Admin should review the error and fix any issues"
          fi

      - name: ğŸ”” Notification Status
        if: success()
        run: |
          echo "ğŸ“§ GitHub will send email notifications if this job fails"
          echo "ğŸ“‹ Check the Actions tab for detailed sync history"
          echo "ğŸ¯ Monitor your Supabase Edge Function logs for detailed insights"